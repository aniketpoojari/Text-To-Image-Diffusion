schema: '2.0'
stages:
  training:
    cmd: python src/trainingjob.py --config=params.yaml
    deps:
    - path: src/code/dataloader.py
      hash: md5
      md5: ac1811002a1c4a98a2124a81a3f3ef37
      size: 2386
    - path: src/code/training_sagemaker.py
      hash: md5
      md5: cc2a01d9d361a9e9c06f3439170c1134
      size: 16367
    - path: src/code/training_sagemaker_deepspeed.py
      hash: md5
      md5: 9bdc07c6477436a083d6faf4b6b39929
      size: 18926
    - path: src/trainingjob.py
      hash: md5
      md5: 3fbd332280b258704c1a6121a21b7453
      size: 4127
    params:
      params.yaml:
        DDPMScheduler.T: 1000
        clip.max_length: 77
        data.train_size: 3000
        data.val_size: 500
        mlflow.experiment_name: Training Diffusion 5
        mlflow.registered_model_name: Diffusion
        mlflow.run_name: 1st
        mlflow.s3_mlruns_bucket: text-to-image-aniket-mlflow
        mlflow.server_uri: https://dagshub.com/aniketpoojari/Text-To-Image-Diffusion.mlflow
        mlflow.tracking_password: 38fa619a54d7cdde5e6dcaa55a01a1c14f329bc2
        mlflow.tracking_username: aniketpoojari
        pytorch_estimator.entry_point: training_sagemaker_deepspeed.py
        pytorch_estimator.framework_version: 2.6.0
        pytorch_estimator.instance_count: 2
        pytorch_estimator.instance_type: ml.g4dn.xlarge
        pytorch_estimator.max_run: 7200
        pytorch_estimator.max_wait: 7200
        pytorch_estimator.py_version: py312
        pytorch_estimator.role: arn:aws:iam::975050169307:role/text-to-image-role
        pytorch_estimator.s3_train_data: s3://text-to-image-aniket
        pytorch_estimator.source_dir: src/code
        pytorch_estimator.use_spot_instances: true
        training.batch_size: 16
        training.num_epochs: 10
        training.unet_learning_rate: 0.0002
        training.vae_learning_rate: 0.0001
        training.weight_decay: 0.01
        unet.act_fn: silu
        unet.attention_head_dim: 64
        unet.block_out_channels: '1024'
        unet.cross_attention_dim: 768
        unet.down_block_types: CrossAttnDownBlock2D
        unet.dropout: 0.05
        unet.image_size: 16,16
        unet.in_channels: 4
        unet.layers_per_block: 2
        unet.mid_block_type: UNetMidBlock2DCrossAttn
        unet.norm_num_groups: 16
        unet.out_channels: 4
        unet.time_embedding_type: positional
        unet.up_block_types: CrossAttnUpBlock2D
        vae.image_size: 128,128
    outs:
    - path: training_completion.txt
      hash: md5
      md5: 17564fcb4bea8ab0fa36c616aae92bd1
      size: 41
  log_training_model:
    cmd: python src/log_training_model.py --config=params.yaml
    deps:
    - path: src/log_training_model.py
      hash: md5
      md5: df8fc31a640e290e0340ab9d1808f4a4
      size: 2042
    - path: training_completion.txt
      hash: md5
      md5: 17564fcb4bea8ab0fa36c616aae92bd1
      size: 41
    params:
      params.yaml:
        mlflow.experiment_name: Training Diffusion 5
        mlflow.s3_mlruns_bucket: text-to-image-aniket-mlflow
        mlflow.server_uri: https://dagshub.com/aniketpoojari/Text-To-Image-Diffusion.mlflow
    outs:
    - path: saved_models/diffuser.pth
      hash: md5
      md5: e8bc4e4abe7eee7819ebd1c54d03276a
      size: 109217092
    - path: saved_models/vae.pth
      hash: md5
      md5: 25e99140b00fc3ae413fef7882fff911
      size: 334736274
  data-push:
    cmd: aws s3 cp data/raw/flowers s3://text-to-image-diffusion-aniket --recursive
    deps:
    - path: data/raw/flowers
      hash: md5
      md5: c1049fd5191c10d36b1a29ec92f5d865.dir
      size: 352971117
      nfiles: 16378
  ecr-login:
    cmd: aws ecr get-login-password --region us-west-2 | docker login --username AWS
      --password-stdin 975050169307.dkr.ecr.us-west-2.amazonaws.com
    deps:
    - path: src/Dockerfile
      hash: md5
      md5: 908c6c7d442c2ae864f19a077a8e6383
      size: 528
    - path: src/code/dataloader.py
      hash: md5
      md5: 5dd15a065eae81b5867a3509e8215824
      size: 2381
    - path: src/code/training_sagemaker.py
      hash: md5
      md5: 99f0fe90f01f37404defbcf1ca65e10e
      size: 12844
  build-docker:
    cmd: cd src && docker build -t diffusion . && docker tag diffusion:latest 975050169307.dkr.ecr.us-west-2.amazonaws.com/diffusion:latest
    deps:
    - path: src/Dockerfile
      hash: md5
      md5: e0fcb02430e4a776ce52bad6db583680
      size: 2323
    - path: src/dataloader.py
      hash: md5
      md5: 5dd15a065eae81b5867a3509e8215824
      size: 2381
    - path: src/training_sagemaker.py
      hash: md5
      md5: 99f0fe90f01f37404defbcf1ca65e10e
      size: 12844
  docker-push:
    cmd: cd src && docker push 975050169307.dkr.ecr.us-west-2.amazonaws.com/diffusion:latest
    deps:
    - path: src/Dockerfile
      hash: md5
      md5: e0fcb02430e4a776ce52bad6db583680
      size: 2323
    - path: src/dataloader.py
      hash: md5
      md5: 5dd15a065eae81b5867a3509e8215824
      size: 2381
    - path: src/training_sagemaker.py
      hash: md5
      md5: 99f0fe90f01f37404defbcf1ca65e10e
      size: 12844
